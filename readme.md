# Документация трейдинг-бота

## Описание проекта

Автоматизированный трейдинг-бот для торговли криптовалютами на бирже Bybit с использованием технического анализа и машинного обучения. Бот принимает торговые сигналы через HTTP API и выполняет автоматические сделки с расширенными функциями управления рисками.

## Основные возможности

### Торговые функции
- **Лимитные ордера** с автоматической отменой по таймауту
- **Отложенный стоп-лосс** с настраиваемой задержкой
- **Трейлинг стоп** для максимизации прибыли
- **Автоматическое закрытие позиций** при достижении целей
- **Управление кредитным плечом** и размером позиций

### Аналитические функции
- **Технический анализ** с расчетом индикаторов в реальном времени
- **Нейросетевой анализ** на основе Transformer архитектуры
- **Историческая выгрузка данных** с биржи
- **Формирование датасетов** для обучения моделей

### Интерфейс и уведомления
- **Telegram бот** для управления и мониторинга
- **Веб-интерфейс** для приема торговых сигналов
- **Визуальные отчеты** с графиками позиций
- **Real-time уведомления** о торговых событиях

## Архитектура системы

### Микросервисы

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   Open Position │    │ Position Watcher│    │   Set Stop      │
│      (HTTP)     │    │   (WebSocket)   │    │   (Timer)       │
└─────────────────┘    └─────────────────┘    └─────────────────┘
         │                       │                       │
         └───────────────────────┼───────────────────────┘
                                 │
         ┌─────────────────┐     │     ┌─────────────────┐
         │  Cancel Order   │     │     │ Trailing Stop   │
         │    (Timer)      │     │     │   (WebSocket)   │
         └─────────────────┘     │     └─────────────────┘
                                 │
                    ┌─────────────────┐
                    │ Position Service │
                    │   (Core Logic)   │
                    └─────────────────┘
                                 │
                    ┌─────────────────┐
                    │  Bybit Client   │
                    │     (API)       │
                    └─────────────────┘
```

### Компоненты Go приложения

**Основные сервисы:**
- `cmd/main.go` - Точка входа, запуск всех горутин
- `internal/service/position/` - Бизнес-логика управления позициями
- `internal/repository/position/` - Слой данных для позиций
- `pkg/api/bybit/` - Клиент для работы с Bybit API
- `pkg/calculator/` - Математические расчеты для торговли

**Приложения:**
- `internal/app/open-position/` - HTTP сервер для приема сигналов
- `internal/app/position-watcher/` - WebSocket мониторинг позиций
- `internal/app/set-stop/` - Автоматическая установка стоп-лоссов
- `internal/app/cancel-order/` - Отмена неисполненных ордеров

### Компоненты Python приложения

**AI и аналитика:**
- `internal/app/ai-analysis/neural_network/` - Нейросетевые модели
- `internal/app/trailing-stop/` - Трейлинг стоп алгоритмы

**Telegram бот:**
- `internal/app/telegram/` - Telegram интерфейс
- Генерация отчетов и уведомлений
- Визуализация торговых данных

## Принцип работы

### Торговый цикл

1. **Получение сигнала**
   ```json
   {
     "symbol": "SOLUSDT",
     "position_side": "Buy",
     "stop_in_percent": "0.65",
     "take_in_percent": "1.49",
     "size": "0.3",
     "leverage": "4"
   }
   ```

2. **Открытие лимитного ордера**
   - Расчет цены с учетом `limit_depth`
   - Установка кредитного плеча
   - Размещение ордера на бирже

3. **Мониторинг исполнения**
   - WebSocket отслеживание статуса позиции
   - Автоматическая отмена по таймауту

4. **Управление позицией**
   - Установка Take Profit сразу после исполнения
   - Отложенная установка Stop Loss
   - Активация трейлинг стопа

5. **Закрытие позиции**
   - По достижении Take Profit/Stop Loss
   - Уведомления в Telegram
   - Сохранение статистики

### Трейлинг стоп алгоритм

```python
if passed_step_in_percent > step_move_stop_in_percent:
    if position_side == 'Buy':
        new_stop_price = open_price * (1 + step_price_in_percent / 100)
        if profit_condition_met:
            update_stop_price(new_stop_price)
```

### Нейросетевой анализ

**Архитектура модели:**
- Transformer Encoder для анализа временных рядов
- Входные данные: OHLCV + технические индикаторы
- Выходные данные: 3 класса (Buy/Sell/Hold)

**Процесс обучения:**
1. Загрузка исторических данных (`get_klines.py`)
2. Расчет технических индикаторов
3. Формирование датасета (`create_dataset.py`)
4. Grid Search оптимизация гиперпараметров
5. Обучение и валидация модели

## Установка и запуск

### Требования

- Docker & Docker Compose
- Python 3.8+
- Go 1.19+
- SSL сертификат для домена

### Настройка переменных окружения

Создайте файл `.env`:

```bash
# Основные настройки
DOMAIN=your-domain.com
ROOT_PATH=/path/to/project

# Telegram
BOT_TOKEN=your_telegram_bot_token

# Bybit API
API_KEY=your_bybit_api_key
API_SECRET_KEY=your_bybit_secret_key

# Сервер
MAIN_SERVER=https://your-domain.com
```

### Первичная установка

```bash
# 1. Установка SSL сертификата
./cmd/user/install-ssl.sh

# 2. Запуск системы
./cmd/user/start-bot.sh
```

### Управление системой

```bash
# Запуск
./cmd/user/start-bot.sh

# Перезапуск
./cmd/user/restart-bot.sh

# Остановка
./cmd/user/stop-bot.sh

# Перевыпуск SSL
./cmd/user/reinstall-ssl.sh
```

## API Endpoints

### Управление позициями

**POST** `/api/position/control`

```json
{
  "Symbol": "SOLUSDT",
  "Side": "BUY"
}
```

### Telegram уведомления

**POST** `/telegram/position_opened` - Уведомление об открытии позиции
**POST** `/telegram/position_closed` - Уведомление о закрытии позиции
**POST** `/telegram/set_stop` - Уведомление об установке стопа
**POST** `/telegram/trailing_stop_activated` - Уведомление о трейлинге

## Конфигурация торговли

### Основные параметры

```go
type Config struct {
    Maker                     decimal.Decimal // 0.001 (0.1%)
    Taker                     decimal.Decimal // 0.002 (0.2%)
    SecondsToCancelLimitOrder int             // 30 секунд
    SecondsToSetStop          int             // 30 секунд
    Leverage                  decimal.Decimal // 3x
    MaxLoss                   decimal.Decimal // -1% (не используется)
}
```

### Параметры сигнала

- `limit_depth` - Глубина лимитного ордера от текущей цены (%)
- `time_to_set_stop` - Задержка установки стоп-лосса (секунды)
- `time_to_cancel_order` - Время до отмены неисполненного ордера (секунды)
- `interval_stop_in_percent` - Интервал для трейлинг стопа (%)
- `step_move_stop_in_percent` - Шаг движения стопа (%)

## Мониторинг и отладка

### Telegram команды

- `/start` - Регистрация для уведомлений
- `Информация об аккаунте` - Баланс и статистика
- `Активные позиции` - Текущие открытые позиции
- `Закрытые позиции` - История сделок
- `Сбросить статистику` - Очистка базы данных

### Логирование

Все торговые события логируются с помощью `slog`:
- Открытие/закрытие позиций
- Ошибки API
- Изменения стоп-лоссов и тейк-профитов

## Безопасность

### API ключи
- Храните API ключи в переменных окружения
- Используйте ключи только с необходимыми разрешениями
- Регулярно ротируйте ключи

### Сетевая безопасность
- Обязательное использование HTTPS
- Настройка firewall для ограничения доступа
- Мониторинг подозрительной активности

## Риски и ограничения

### Торговые риски
- Проскальзывание при высокой волатильности
- Разрывы цен (gaps) могут обойти стоп-лоссы
- Технические сбои биржи или интернет-соединения

### Технические ограничения
- Зависимость от стабильности API Bybit
- Требует постоянного интернет-соединения
- Ограничения по частоте запросов к API

### Рекомендации
- Начинайте с минимальных сумм
- Тестируйте на демо-аккаунте
- Регулярно мониторьте работу бота
- Имейте план аварийного отключения

## Техническая поддержка

При возникновении проблем:
1. Проверьте логи контейнеров Docker
2. Убедитесь в корректности API ключей
3. Проверьте сетевое соединение
4. Проверьте баланс аккаунта на бирже

Система спроектирована для автономной работы, но требует периодического мониторинга и обслуживания.
